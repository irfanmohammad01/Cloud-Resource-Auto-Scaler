openapi: 3.0.0
info:
  title: Cloud Resource Autoscaler API
  description: |
    API for monitoring and auto-scaling cloud resources based on metrics.
    
    ## Features
    - Mock instances for testing without AWS
    - Time-based scaling with 5-minute sustained usage checks
    - Instance capacity tracking
    - Prolonged metric simulation
    
    ## Authentication
    Most endpoints require a JWT token obtained from the login endpoint.
    Use the "Authorize" button to set your Bearer token.
  version: 2.0.0
  contact:
    name: API Support
    
servers:
  - url: http://localhost:5000
    description: Local development server

tags:
  - name: Authentication
    description: User registration and authentication
  - name: Instances
    description: Instance management and monitoring
  - name: Metrics
    description: Metrics and scaling decisions

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      
  schemas:
    User:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
        email:
          type: string
          format: email
        created_at:
          type: string
          format: date-time
        instance_count:
          type: integer
        monitoring_count:
          type: integer
          
    Instance:
      type: object
      properties:
        id:
          type: string
          format: uuid
        instance_id:
          type: string
        instance_type:
          type: string
        region:
          type: string
        is_monitoring:
          type: boolean
        is_mock:
          type: boolean
        cpu_capacity:
          type: number
          format: float
        memory_capacity:
          type: number
          format: float
        network_capacity:
          type: number
          format: float
        current_scale_level:
          type: integer
        created_at:
          type: string
          format: date-time
          
    Metric:
      type: object
      properties:
        id:
          type: string
          format: uuid
        instance_id:
          type: string
        timestamp:
          type: string
          format: date-time
        cpu_utilization:
          type: number
          format: float
          nullable: true
        memory_usage:
          type: number
          format: float
          nullable: true
        network_in:
          type: integer
          format: int64
          nullable: true
        network_out:
          type: integer
          format: int64
          nullable: true
        is_outlier:
          type: boolean
        outlier_type:
          type: string
          nullable: true
          enum: [scale_up, scale_down, null]
          
    ScalingDecision:
      type: object
      properties:
        id:
          type: string
          format: uuid
        instance_id:
          type: string
        timestamp:
          type: string
          format: date-time
        cpu_utilization:
          type: number
          format: float
          nullable: true
        memory_usage:
          type: number
          format: float
          nullable: true
        network_in:
          type: integer
          format: int64
          nullable: true
        network_out:
          type: integer
          format: int64
          nullable: true
        decision:
          type: string
          enum: [scale_up, scale_down, no_action]
        reason:
          type: string
          
    Error:
      type: object
      properties:
        error:
          type: string

paths:
  /api/:
    get:
      tags:
        - Authentication
      summary: Health check
      description: Check if the API is running
      responses:
        '200':
          description: API is running
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  version:
                    type: string
                    
  /api/auth/register:
    post:
      tags:
        - Authentication
      summary: Register new user
      description: Create a new user account
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  user_id:
                    type: string
                    format: uuid
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
                
  /api/auth/login:
    post:
      tags:
        - Authentication
      summary: Login
      description: Authenticate and receive JWT token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  token:
                    type: string
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
                
  /api/auth/me:
    get:
      tags:
        - Authentication
      summary: Get user information
      description: Get current authenticated user's profile and statistics
      security:
        - BearerAuth: []
      responses:
        '200':
          description: User information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
                
  /api/instances/:
    post:
      tags:
        - Instances
      summary: Register instance
      description: Register an AWS EC2 instance or mock instance for monitoring
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - instance_id
                - instance_type
                - region
              properties:
                instance_id:
                  type: string
                  description: AWS instance ID or mock identifier
                instance_type:
                  type: string
                  description: Instance type (e.g., t2.micro)
                region:
                  type: string
                  description: AWS region or 'mock'
                is_mock:
                  type: boolean
                  default: false
                  description: Set to true for mock instances (no AWS required)
      responses:
        '201':
          description: Instance registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  instance:
                    $ref: '#/components/schemas/Instance'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
                
    get:
      tags:
        - Instances
      summary: Get all instances
      description: Retrieve all instances registered by the authenticated user
      security:
        - BearerAuth: []
      responses:
        '200':
          description: List of instances
          content:
            application/json:
              schema:
                type: object
                properties:
                  instances:
                    type: array
                    items:
                      $ref: '#/components/schemas/Instance'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
                
  /api/instances/{instance_id}/monitor/start:
    patch:
      tags:
        - Instances
      summary: Start monitoring
      description: Start monitoring an instance (metrics every 30s, decisions every 15s)
      security:
        - BearerAuth: []
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Monitoring started
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
                
  /api/instances/{instance_id}/monitor/stop:
    patch:
      tags:
        - Instances
      summary: Stop monitoring
      description: Stop monitoring an instance
      security:
        - BearerAuth: []
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Monitoring stopped
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
                
  /api/instances/{instance_id}:
    delete:
      tags:
        - Instances
      summary: Delete instance
      description: Soft delete an instance (monitoring must be stopped first)
      security:
        - BearerAuth: []
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
          description: Instance ID to delete
      responses:
        '200':
          description: Instance deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Instance deleted successfully"
        '400':
          description: Bad request (e.g., monitoring still active)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                monitoring_active:
                  value:
                    error: "Cannot delete instance while monitoring is active. Please stop monitoring first."
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden (user doesn't own instance)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                not_owner:
                  value:
                    error: "Unauthorized: You don't own this instance"
        '404':
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                not_found:
                  value:
                    error: "Instance not found"
                
  /api/metrics/{instance_id}:
    get:
      tags:
        - Metrics
      summary: Get instance metrics
      description: |
        Retrieve metrics for a specific instance with pagination support.
        
        **Pagination**: Use `page` and `page_size` parameters to fetch data in chunks.
        The response includes pagination metadata to help with navigation.
        
        **Backward Compatibility**: The legacy `limit` parameter is still supported.
      security:
        - BearerAuth: []
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number (1-indexed)
        - name: page_size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
          description: Number of items per page (max 100)
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
          description: (Legacy) Maximum number of metrics to return. Overrides page_size and resets to page 1.
      responses:
        '200':
          description: Metrics retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  instance_id:
                    type: string
                  metrics:
                    type: array
                    items:
                      $ref: '#/components/schemas/Metric'
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                        description: Current page number
                      page_size:
                        type: integer
                        description: Number of items per page
                      total_count:
                        type: integer
                        description: Total number of metrics available
                      total_pages:
                        type: integer
                        description: Total number of pages
                      has_next:
                        type: boolean
                        description: Whether there is a next page
                      has_prev:
                        type: boolean
                        description: Whether there is a previous page
              examples:
                paginated_response:
                  summary: Paginated metrics response
                  value:
                    instance_id: "i-1234567890abcdef0"
                    metrics:
                      - id: "123e4567-e89b-12d3-a456-426614174000"
                        instance_id: "i-1234567890abcdef0"
                        timestamp: "2026-01-29T09:30:00Z"
                        cpu_utilization: 45.5
                        memory_usage: 60.2
                        network_in: 1024000
                        network_out: 512000
                        is_outlier: false
                        outlier_type: null
                    pagination:
                      page: 1
                      page_size: 10
                      total_count: 150
                      total_pages: 15
                      has_next: true
                      has_prev: false
        '400':
          description: Bad request (invalid pagination parameters)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_page:
                  value:
                    error: "Page must be >= 1"
                invalid_page_size:
                  value:
                    error: "Page size must be between 1 and 100"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
                
  /api/metrics/decisions/{instance_id}:
    get:
      tags:
        - Metrics
      summary: Get scaling decisions
      description: |
        Retrieve scaling decisions for a specific instance with pagination support.
        
        **Pagination**: Use `page` and `page_size` parameters to fetch data in chunks.
        The response includes pagination metadata to help with navigation.
        
        **Backward Compatibility**: The legacy `limit` parameter is still supported.
      security:
        - BearerAuth: []
      parameters:
        - name: instance_id
          in: path
          required: true
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
          description: Page number (1-indexed)
        - name: page_size
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 10
          description: Number of items per page (max 100)
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
          description: (Legacy) Maximum number of decisions to return. Overrides page_size and resets to page 1.
      responses:
        '200':
          description: Decisions retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  instance_id:
                    type: string
                  decisions:
                    type: array
                    items:
                      $ref: '#/components/schemas/ScalingDecision'
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                        description: Current page number
                      page_size:
                        type: integer
                        description: Number of items per page
                      total_count:
                        type: integer
                        description: Total number of decisions available
                      total_pages:
                        type: integer
                        description: Total number of pages
                      has_next:
                        type: boolean
                        description: Whether there is a next page
                      has_prev:
                        type: boolean
                        description: Whether there is a previous page
              examples:
                paginated_response:
                  summary: Paginated decisions response
                  value:
                    instance_id: "i-1234567890abcdef0"
                    decisions:
                      - id: "456e7890-e89b-12d3-a456-426614174001"
                        instance_id: "i-1234567890abcdef0"
                        timestamp: "2026-01-29T09:30:00Z"
                        cpu_utilization: 85.5
                        memory_usage: 78.2
                        network_in: 2048000
                        network_out: 1024000
                        decision: "scale_up"
                        reason: "High sustained CPU usage over 5 minutes"
                    pagination:
                      page: 1
                      page_size: 10
                      total_count: 75
                      total_pages: 8
                      has_next: true
                      has_prev: false
        '400':
          description: Bad request (invalid pagination parameters)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalid_page:
                  value:
                    error: "Page must be >= 1"
                invalid_page_size:
                  value:
                    error: "Page size must be between 1 and 100"
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
                
  /api/metrics/simulate:
    post:
      tags:
        - Metrics
      summary: Simulate metrics
      description: |
        Create simulated metrics for testing. Supports two modes:
        1. **Instant**: Single metric with provided values
        2. **Prolonged**: Multiple metrics over duration (for testing sustained usage)
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - instance_id
              properties:
                instance_id:
                  type: string
                cpu_utilization:
                  type: number
                  format: float
                  minimum: 0
                  maximum: 100
                memory_usage:
                  type: number
                  format: float
                  minimum: 0
                  maximum: 100
                network_in:
                  type: integer
                  format: int64
                network_out:
                  type: integer
                  format: int64
                duration_minutes:
                  type: integer
                  description: Duration for prolonged simulation (optional)
                interval_seconds:
                  type: integer
                  default: 30
                  description: Interval between metrics for prolonged simulation
            examples:
              instant:
                summary: Instant simulation
                value:
                  instance_id: "i-1234567890abcdef0"
                  cpu_utilization: 95.5
                  memory_usage: 70.2
              prolonged:
                summary: Prolonged simulation (10 minutes)
                value:
                  instance_id: "i-1234567890abcdef0"
                  cpu_utilization: 95.5
                  memory_usage: 70.2
                  duration_minutes: 10
                  interval_seconds: 30
      responses:
        '201':
          description: Metrics created
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      message:
                        type: string
                      metric:
                        $ref: '#/components/schemas/Metric'
                  - type: object
                    properties:
                      message:
                        type: string
                      metrics_created:
                        type: integer
                      duration_minutes:
                        type: integer
                      interval_seconds:
                        type: integer
                      sample_metrics:
                        type: array
                        items:
                          type: object
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Instance not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
